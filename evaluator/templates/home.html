<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam Code Evaluator</title>
    
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    
    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/dracula.min.css">
    
    <style>
        body { background-color: #f8f9fa; padding: 30px; }
        .CodeMirror { height: 250px; font-size: 16px; border: 1px solid #ced4da; }
    </style>
</head>
<body>

    <div class="container">
        <h2 class="text-center my-4">Exam Code Evaluator</h2>

        <div class="card shadow">
            <div class="card-body">
                <h5>Question:</h5>
                <p id="examQuestion"><strong>Write a Python function to find the square of a number.</strong></p>

                <input type="hidden" id="expectedOutput" value="25">  <!-- Expected output for grading -->

                <label for="language" class="form-label">Choose Language:</label>
                <select id="language" class="form-select mb-3">
                    <option value="python">Python</option>
                    <option value="javascript">JavaScript</option>
                    <option value="dart">Dart</option>
                </select>

                <textarea id="codeInput"></textarea>

                <div class="text-center mt-3">
                    <button type="submit" class="btn btn-success btn-lg" id="runCode">Submit Exam</button>
                </div>
            </div>
        </div>

        <h3 class="mt-4">Result:</h3>
        <div id="output" class="alert alert-secondary" role="alert">Awaiting submission...</div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- CodeMirror JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/clike/clike.min.js"></script> <!-- Dart -->

    <script>
        // Get CSRF token for Django security
        function getCSRFToken() {
            let cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                let cookie = cookies[i].trim();
                if (cookie.startsWith("csrftoken=")) {
                    return cookie.split("=")[1];
                }
            }
            return "";
        }

        // Initialize CodeMirror
        var editor = CodeMirror.fromTextArea(document.getElementById("codeInput"), {
            mode: "python",
            theme: "dracula",
            lineNumbers: true,
            indentUnit: 4,
            matchBrackets: true
        });

        // Handle language switch
        document.getElementById("language").addEventListener("change", function() {
            let selectedLanguage = this.value;
            if (selectedLanguage === "python") {
                editor.setOption("mode", "python");
            } else if (selectedLanguage === "javascript") {
                editor.setOption("mode", "javascript");
            } else if (selectedLanguage === "dart") {
                editor.setOption("mode", "text/x-csrc"); // Dart uses C-like syntax in CodeMirror
            }
        });

        // Handle exam submission
        document.getElementById("runCode").addEventListener("click", function() {
            let code = editor.getValue();
            let csrfToken = getCSRFToken();
            let language = document.getElementById("language").value;
            let expectedOutput = document.getElementById("expectedOutput").value;
            let outputDiv = document.getElementById("output");

            outputDiv.classList.remove("alert-success", "alert-danger", "alert-secondary");
            outputDiv.classList.add("alert-secondary");
            outputDiv.textContent = "Evaluating...";

            fetch("/evaluate/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "X-CSRFToken": csrfToken,
                },
                body: "code=" + encodeURIComponent(code) + "&language=" + encodeURIComponent(language) + "&expected_output=" + encodeURIComponent(expectedOutput),
            })
            .then(response => response.json())
            .then(data => {
                outputDiv.classList.remove("alert-secondary");
                if (data.result === "pass") {
                    outputDiv.classList.add("alert-success");
                    outputDiv.textContent = "✅ Pass! Output matched expected result.";
                } else {
                    outputDiv.classList.add("alert-danger");
                    outputDiv.textContent = "❌ Fail! Output did not match.";
                }
            })
            .catch(error => {
                outputDiv.classList.remove("alert-secondary");
                outputDiv.classList.add("alert-danger");
                outputDiv.textContent = "Error connecting to server.";
            });
        });
    </script>

</body>
</html>