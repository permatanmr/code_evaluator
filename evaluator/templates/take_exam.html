<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Exam Page</title>
    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />

    <!-- CodeMirror CSS -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/dracula.min.css"
    />

    <script>
      // JavaScript function to handle active selection
      function toggleActiveBox(id, question, counter) {
        document.querySelectorAll(".question-box").forEach((box) => {
          box.classList.remove("active-box");

        });
        document.getElementById(id).classList.add("active-box");
        document.getElementById("examQuestion").textContent = question;
        document.getElementById("question-number").textContent = 'Question '+counter
        editor.setValue(document.getElementById("question_code-"+counter).value)
      }
    </script>

    <style>
      body {
        background-color: #f8f9fa;
        padding: 30px;
      }


      /* Styling for question boxes */
      .question-box {
        width: 50px; /* Fixed width */
        height: 50px; /* Fixed height */
        border: 2px solid #ddd;
        border-radius: 10px;
        padding: 15px;
        margin:3px;
        text-align: center;
        display: flex;
        flex-direction: column;
        justify-content: center;
        transition: 0.3s;
        cursor: pointer;
      }

      /* Active state */
      .active-box {
        border-color: #00ADB5;
        background-color: #00ADB5;
        color: #FFF;
      }

      .CodeMirror {
        height: 250px;
        font-size: 16px;
        border: 1px solid #ced4da;
      }

      .hidden {
        display: none
      }
    </style>
  </head>
  <body class="container mt-5">
    <h2 class="text-center">Exam Code Evaluator</h2>
    <p>Welcome, {{ request.user.email }}!</p>
    <a href="{% url 'logout' %}" class="btn btn-danger">Logout</a>
    <br /><br /><br />

    <!-- Exam Code Evaluation Content Here -->
    <!-- Question Selection -->
    {% if questions %} 
    </div>
    <div class="row text-center mb-3">
    {% for q in questions %}
    <div
      id="question-{{ q.id }}"
      class="question-box"
      onclick="toggleActiveBox('question-{{ q.id }}', '{{q.description}}', '{{forloop.counter}}')"
    >
      <h5 class="m-0">{{ forloop.counter }}</h5>
      <input type="hidden" id="prog-{{forloop.counter}}" value="{{q.programming_language}}" />
      <input type="hidden" id="description-{{forloop.counter}}" value="{{q.description}}" />
      <input type="hidden" id="qid-{{forloop.counter}}" value="{{q.id}}" />
      <input type="hidden" id="question_code-{{forloop.counter}}" value="{{q.question_code}}" />
  </div>
    {% endfor %} 
</div>
    {% else %}
    <p class="text-center">No questions available.</p>
    {% endif %}

    <div class="card shadow">
      <div class="card-body">
        <h5 class="m-0" id="question-number"></h5>
        <p id="examQuestion">
          <strong></strong>
        </p>
        <input type="hidden" id="expectedOutput" value="25" />

        <label for="language" class="form-label"></label>
        <select type="hidden" id="language" class="form-select mb-3 hidden">
          <option value="python">Python</option>
          <option value="javascript">JavaScript</option>
          <option value="dart">Dart</option>
        </select>

        <textarea id="codeInput"></textarea>

        <div class="text-center mt-3">
          <button type="submit" class="btn btn-success btn-lg" id="runCode">
            Submit Exam
          </button>
        </div>
      </div>
    </div>

    <h3 class="mt-4">Result:</h3>
    <div id="output" class="alert alert-secondary" role="alert">
      Awaiting submission...
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- CodeMirror JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/clike/clike.min.js"></script>
    <!-- Dart -->

    <script>
      function getCSRFToken() {
        let cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
          let cookie = cookies[i].trim();
          if (cookie.startsWith("csrftoken=")) {
            return cookie.split("=")[1];
          }
        }
        return "";
      }

      var editor = CodeMirror.fromTextArea(
        document.getElementById("codeInput"),
        {
          mode: "python",
          theme: "dracula",
          lineNumbers: true,
          indentUnit: 4,
          matchBrackets: true,
        }
      );

      document
        .getElementById("language")
        .addEventListener("change", function () {
          let selectedLanguage = this.value;
          if (selectedLanguage === "python") {
            editor.setOption("mode", "python");
          } else if (selectedLanguage === "javascript") {
            editor.setOption("mode", "javascript");
          } else if (selectedLanguage === "dart") {
            editor.setOption("mode", "text/x-csrc");
          }
        });

      // Question selection logic
      {% comment %} document.querySelectorAll(".question-box").forEach((box) => {
        box.addEventListener("click", function () {
          document
            .querySelectorAll(".question-box")
            .forEach((b) => b.classList.remove("active"));
          this.classList.add("active");

          let selectedQuestion = this.getAttribute("data-question");
          let questionText = "";
          let expectedOutput = "";

          if (selectedQuestion === "square") {
            questionText = "Write a function to find the square of a number.";
            expectedOutput = "25"; // Example input: 5
          } else if (selectedQuestion === "factorial") {
            questionText =
              "Write a function to find the factorial of a number.";
            expectedOutput = "120"; // Example input: 5
          } else if (selectedQuestion === "reverse") {
            questionText = "Write a function to reverse a string.";
            expectedOutput = "olleH"; // Example input: "Hello"
          }

          document.getElementById("examQuestion").textContent = questionText;
          document.getElementById("expectedOutput").value = expectedOutput;
        });
      }); {% endcomment %}

      document.getElementById("runCode").addEventListener("click", function () {
        let code = editor.getValue();
        let csrfToken = getCSRFToken();
        let language = document.getElementById("language").value;
        let expectedOutput = document.getElementById("expectedOutput").value;
        let outputDiv = document.getElementById("output");

        outputDiv.classList.remove(
          "alert-success",
          "alert-danger",
          "alert-secondary"
        );
        outputDiv.classList.add("alert-secondary");
        outputDiv.textContent = "Evaluating...";

        fetch("/evaluate/", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": csrfToken,
          },
          body:
            "code=" +
            encodeURIComponent(code) +
            "&language=" +
            encodeURIComponent(language) +
            "&expected_output=" +
            encodeURIComponent(expectedOutput),
        })
          .then((response) => response.json())
          .then((data) => {
            outputDiv.classList.remove("alert-secondary");
            if (data.result === "pass") {
              outputDiv.classList.add("alert-success");
              outputDiv.textContent =
                "✅ Pass! Output matched expected result.";
            } else {
              outputDiv.classList.add("alert-danger");
              outputDiv.textContent = "❌ Fail! Output did not match.";
            }
          })
          .catch((error) => {
            outputDiv.classList.remove("alert-secondary");
            outputDiv.classList.add("alert-danger");
            outputDiv.textContent = "Error connecting to server.";
          });
      });

      document.getElementById("question-1").classList.add("active-box");
      document.getElementById("question-number").textContent = 'Question 1'
      document.getElementById("examQuestion").textContent = document.getElementById("description-1").value;
      editor.setValue(document.getElementById("question_code-1").value)

    </script>
  </body>
</html>
