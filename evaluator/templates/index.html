<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Exam Page</title>
    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />

    <!-- CodeMirror CSS -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/dracula.min.css"
    />

    <style>
      body {
        background-color: #f8f9fa;
        padding: 30px;
      }
      .CodeMirror {
        height: 250px;
        font-size: 16px;
        border: 1px solid #ced4da;
      }
      .question-box {
        cursor: pointer;
        padding: 15px;
        border-radius: 10px;
        font-size: 20px;
        font-weight: bold;
      }
      .question-box:hover,
      .question-box.active {
        background-color: #0d6efd;
        color: white;
      }
    </style>
  </head>
  <body class="container mt-5">
    <h2 class="text-center">Exam Code Evaluator</h2>
    <p>Welcome, {{ request.user.username }}!</p>
    <a href="{% url 'logout' %}" class="btn btn-danger">Logout</a>
    <br><br><br>

    <!-- Exam Code Evaluation Content Here -->
    <!-- Question Selection -->
    <div class="row text-center mb-3">
      <div class="col-md-4">
        <div class="question-box border shadow-sm" data-question="square">
          1
        </div>
      </div>
      <div class="col-md-4">
        <div class="question-box border shadow-sm" data-question="factorial">
          2
        </div>
      </div>
      <div class="col-md-4">
        <div class="question-box border shadow-sm" data-question="reverse">
          3
        </div>
      </div>
    </div>

    <div class="card shadow">
      <div class="card-body">
        <h5>Question:</h5>
        <p id="examQuestion">
          <strong>Write a function to find the square of a number.</strong>
        </p>
        <input type="hidden" id="expectedOutput" value="25" />

        <label for="language" class="form-label">Choose Language:</label>
        <select id="language" class="form-select mb-3">
          <option value="python">Python</option>
          <option value="javascript">JavaScript</option>
          <option value="dart">Dart</option>
        </select>

        <textarea id="codeInput"></textarea>

        <div class="text-center mt-3">
          <button type="submit" class="btn btn-success btn-lg" id="runCode">
            Submit Exam
          </button>
        </div>
      </div>
    </div>

    <h3 class="mt-4">Result:</h3>
    <div id="output" class="alert alert-secondary" role="alert">
      Awaiting submission...
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- CodeMirror JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/clike/clike.min.js"></script>
    <!-- Dart -->

    <script>
      function getCSRFToken() {
        let cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
          let cookie = cookies[i].trim();
          if (cookie.startsWith("csrftoken=")) {
            return cookie.split("=")[1];
          }
        }
        return "";
      }

      var editor = CodeMirror.fromTextArea(
        document.getElementById("codeInput"),
        {
          mode: "python",
          theme: "dracula",
          lineNumbers: true,
          indentUnit: 4,
          matchBrackets: true,
        }
      );

      document
        .getElementById("language")
        .addEventListener("change", function () {
          let selectedLanguage = this.value;
          if (selectedLanguage === "python") {
            editor.setOption("mode", "python");
          } else if (selectedLanguage === "javascript") {
            editor.setOption("mode", "javascript");
          } else if (selectedLanguage === "dart") {
            editor.setOption("mode", "text/x-csrc");
          }
        });

      // Question selection logic
      document.querySelectorAll(".question-box").forEach((box) => {
        box.addEventListener("click", function () {
          document
            .querySelectorAll(".question-box")
            .forEach((b) => b.classList.remove("active"));
          this.classList.add("active");

          let selectedQuestion = this.getAttribute("data-question");
          let questionText = "";
          let expectedOutput = "";

          if (selectedQuestion === "square") {
            questionText = "Write a function to find the square of a number.";
            expectedOutput = "25"; // Example input: 5
          } else if (selectedQuestion === "factorial") {
            questionText =
              "Write a function to find the factorial of a number.";
            expectedOutput = "120"; // Example input: 5
          } else if (selectedQuestion === "reverse") {
            questionText = "Write a function to reverse a string.";
            expectedOutput = "olleH"; // Example input: "Hello"
          }

          document.getElementById("examQuestion").textContent = questionText;
          document.getElementById("expectedOutput").value = expectedOutput;
        });
      });

      document.getElementById("runCode").addEventListener("click", function () {
        let code = editor.getValue();
        let csrfToken = getCSRFToken();
        let language = document.getElementById("language").value;
        let expectedOutput = document.getElementById("expectedOutput").value;
        let outputDiv = document.getElementById("output");

        outputDiv.classList.remove(
          "alert-success",
          "alert-danger",
          "alert-secondary"
        );
        outputDiv.classList.add("alert-secondary");
        outputDiv.textContent = "Evaluating...";

        fetch("/evaluate/", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": csrfToken,
          },
          body:
            "code=" +
            encodeURIComponent(code) +
            "&language=" +
            encodeURIComponent(language) +
            "&expected_output=" +
            encodeURIComponent(expectedOutput),
        })
          .then((response) => response.json())
          .then((data) => {
            outputDiv.classList.remove("alert-secondary");
            if (data.result === "pass") {
              outputDiv.classList.add("alert-success");
              outputDiv.textContent =
                "✅ Pass! Output matched expected result.";
            } else {
              outputDiv.classList.add("alert-danger");
              outputDiv.textContent = "❌ Fail! Output did not match.";
            }
          })
          .catch((error) => {
            outputDiv.classList.remove("alert-secondary");
            outputDiv.classList.add("alert-danger");
            outputDiv.textContent = "Error connecting to server.";
          });
      });
    </script>
  </body>
</html>
